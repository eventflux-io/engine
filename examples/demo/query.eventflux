-- EventFlux Advanced Demo: Real-Time Bitcoin Trend Detection
--
-- Demonstrates PATTERN PROCESSING for detecting market activity and price trends
--
-- Architecture:
--   RawTrades (source) ─> ActivityStats (internal) ─┬─> ActivityPulse (sink)
--                                                   └─> TrendSignal (sink)
--
-- Features demonstrated:
--   - WebSocket source with live Bitcoin trades
--   - Tumbling window aggregation (10-second periods)
--   - CAST expression for type conversion (VARCHAR price to DOUBLE)
--   - PATTERN with EVERY for continuous trend detection
--   - Same-stream pattern (e1=Stream -> e2=Stream)
--   - Arithmetic expressions in pattern queries (e2.count - e1.count)
--   - Multi-query pipeline processing

-- =============================================================================
-- STREAMS
-- =============================================================================

-- Source: Real BTC/USDT trades from Binance (no API key required)
CREATE STREAM RawTrades (
    price VARCHAR,
    quantity VARCHAR,
    symbol VARCHAR,
    trade_time BIGINT
) WITH (
    type = 'source',
    extension = 'websocket',
    format = 'json',
    "websocket.url" = 'wss://stream.binance.com:9443/ws/btcusdt@trade',
    "websocket.reconnect" = 'true',
    "websocket.reconnect.max.attempts" = '-1',
    "json.mapping.price" = '$.p',
    "json.mapping.quantity" = '$.q',
    "json.mapping.symbol" = '$.s',
    "json.mapping.trade_time" = '$.T'
);

-- Internal: 10-second activity statistics
-- This stream aggregates raw trades into periodic activity summaries
-- Uses CAST to convert VARCHAR price to DOUBLE for averaging
CREATE STREAM ActivityStats (
    symbol VARCHAR,
    trade_count BIGINT,
    avg_price DOUBLE,
    period_end BIGINT
);

-- Sink 1: Activity pulse - shows each 10-second period's activity and average price
CREATE STREAM ActivityPulse (
    symbol VARCHAR,
    trades BIGINT,
    avg_price DOUBLE
) WITH (
    type = 'sink',
    extension = 'log',
    format = 'json',
    "log.prefix" = '[PULSE]'
);

-- Sink 2: Trend signal - sequence-detected activity and price trends
-- Compares consecutive 10-second periods to detect momentum
CREATE STREAM TrendSignal (
    symbol VARCHAR,
    prev_trades BIGINT,
    curr_trades BIGINT,
    activity_change BIGINT,
    prev_price DOUBLE,
    curr_price DOUBLE,
    price_change_pct DOUBLE
) WITH (
    type = 'sink',
    extension = 'log',
    format = 'json',
    "log.prefix" = '[TREND]'
);

-- =============================================================================
-- QUERIES
-- =============================================================================

-- Query 1: Aggregate raw trades into 10-second activity windows
-- Counts trades per period and calculates average price
-- Uses CAST to convert VARCHAR price to DOUBLE for averaging
INSERT INTO ActivityStats
SELECT
    symbol,
    COUNT(*) AS trade_count,
    AVG(CAST(price AS DOUBLE)) AS avg_price,
    MAX(trade_time) AS period_end
FROM RawTrades
WINDOW('tumbling', INTERVAL '10' SECOND)
GROUP BY symbol;

-- Query 2: Pass through to activity pulse sink
INSERT INTO ActivityPulse
SELECT
    symbol,
    trade_count AS trades,
    avg_price
FROM ActivityStats;

-- Query 3: PATTERN-BASED TREND DETECTION (Continuous Matching)
-- Uses PATTERN with EVERY to continuously match consecutive 10-second periods
-- Detects if market activity and price are increasing or decreasing
--
-- Pattern: EVERY (e1=ActivityStats -> e2=ActivityStats)
-- - e1 represents the previous period
-- - e2 represents the current period
-- - EVERY enables continuous matching (restarts after each match)
--
-- Note: SEQUENCE would provide strict consecutive matching but currently
-- only matches once. Use PATTERN with EVERY for continuous matching.
--
-- Output:
--   prev_trades: trade count in previous 10-second period
--   curr_trades: trade count in current 10-second period
--   activity_change: difference (positive = increasing activity)
--   prev_price: average price in previous period
--   curr_price: average price in current period
--   price_change_pct: percentage change (positive = price increasing)
INSERT INTO TrendSignal
SELECT
    e2.symbol AS symbol,
    e1.trade_count AS prev_trades,
    e2.trade_count AS curr_trades,
    e2.trade_count - e1.trade_count AS activity_change,
    e1.avg_price AS prev_price,
    e2.avg_price AS curr_price,
    ((e2.avg_price - e1.avg_price) / e1.avg_price) * 100.0 AS price_change_pct
FROM PATTERN (EVERY (e1=ActivityStats -> e2=ActivityStats));
