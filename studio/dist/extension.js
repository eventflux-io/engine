"use strict";var y=Object.create;var v=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var P=(n,e)=>{for(var t in e)v(n,t,{get:e[t],enumerable:!0})},b=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of S(e))!D.call(n,o)&&o!==t&&v(n,o,{get:()=>e[o],enumerable:!(s=k(e,o))||s.enumerable});return n};var w=(n,e,t)=>(t=n!=null?y(T(n)):{},b(e||!n||!n.__esModule?v(t,"default",{value:n,enumerable:!0}):t,n)),j=n=>b(v({},"__esModule",{value:!0}),n);var F={};P(F,{activate:()=>C,deactivate:()=>$});module.exports=j(F);var p=w(require("vscode"));var i=w(require("vscode")),f=w(require("path")),m=class n{constructor(e){this.context=e}static viewType="eventflux.studioEditor";static webviewOptions={enableScripts:!0,retainContextWhenHidden:!0};static register(e){let t=new n(e);return i.window.registerCustomEditorProvider(n.viewType,t,{webviewOptions:{retainContextWhenHidden:!0},supportsMultipleEditorsPerDocument:!1})}async resolveCustomTextEditor(e,t,s){t.webview.options={enableScripts:!0,localResourceRoots:[i.Uri.joinPath(this.context.extensionUri,"webview","dist"),i.Uri.joinPath(this.context.extensionUri,"templates")]},t.webview.html=this.getHtmlForWebview(t.webview);let o=t.webview.onDidReceiveMessage(d=>this.handleMessage(e,t,d)),c=i.workspace.onDidChangeTextDocument(d=>{d.document.uri.toString()===e.uri.toString()&&this.updateWebview(t.webview,e)});t.onDidDispose(()=>{o.dispose(),c.dispose()}),this.updateWebview(t.webview,e)}getHtmlForWebview(e){let t=e.asWebviewUri(i.Uri.joinPath(this.context.extensionUri,"webview","dist","index.js")),s=e.asWebviewUri(i.Uri.joinPath(this.context.extensionUri,"webview","dist","index.css")),o=U();return`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${e.cspSource} 'unsafe-inline' https://cdn.jsdelivr.net; script-src 'nonce-${o}' 'unsafe-eval' https://cdn.jsdelivr.net; img-src ${e.cspSource} https: data:; font-src ${e.cspSource} https://cdn.jsdelivr.net; connect-src ${e.cspSource} https://cdn.jsdelivr.net; worker-src blob:;">
  <link href="${s}" rel="stylesheet">
  <title>EventFlux Studio</title>
</head>
<body>
  <div id="root"></div>
  <script nonce="${o}" src="${t}"></script>
</body>
</html>`}updateWebview(e,t){try{let s=t.getText(),o=s?JSON.parse(s):null;e.postMessage({type:"load",data:o,fileName:f.basename(t.fileName)})}catch(s){console.error("Failed to parse studio file:",s),e.postMessage({type:"error",message:"Failed to parse studio file. Please check the JSON format."})}}async handleMessage(e,t,s){switch(s.type){case"ready":this.updateWebview(t.webview,e);break;case"update":await this.updateDocument(e,s.content);break;case"generateSQL":let o=await this.generateSQL(s.application);t.webview.postMessage({type:"sqlGenerated",sql:o});break;case"showSQL":s.sql&&await this.showGeneratedSQL(s.sql);break;case"saveSQL":s.sql&&await this.saveSQL(e,s.sql);break;case"export":await this.exportApplication(e,s.sql,s.nodes);break;case"getTemplates":let c=await this.getTemplates();t.webview.postMessage({type:"templates",templates:c});break;case"loadTemplate":if(s.templateId){let r=await this.loadTemplate(s.templateId);t.webview.postMessage({type:"templateLoaded",template:r})}break;case"runSimulation":let d=await this.runSimulation(s.application,s.testData);t.webview.postMessage({type:"simulationResult",result:d});break;case"getConfig":let a=i.workspace.getConfiguration("eventflux");t.webview.postMessage({type:"config",config:{gridSize:a.get("studio.gridSize",20),snapToGrid:a.get("studio.snapToGrid",!0),autoSave:a.get("studio.autoSave",!0),engineHost:a.get("engine.host","localhost"),enginePort:a.get("engine.port",9090)}});break}}async updateDocument(e,t){let s=new i.WorkspaceEdit;s.replace(e.uri,new i.Range(0,0,e.lineCount,0),JSON.stringify(t,null,2)),await i.workspace.applyEdit(s)&&await e.save()}async generateSQL(e){return`-- Generated by EventFlux Studio
-- Implementation coming soon`}async showGeneratedSQL(e){let t=await i.workspace.openTextDocument({content:e,language:"sql"});await i.window.showTextDocument(t,i.ViewColumn.Beside)}async saveSQL(e,t){let s=e.uri.fsPath.replace(".eventflux.studio","").replace(".efstudio",""),o=i.Uri.file(`${s}.eventflux`);await i.workspace.fs.writeFile(o,Buffer.from(t)),i.window.showInformationMessage(`SQL saved to ${f.basename(o.fsPath)}`)}async exportApplication(e,t,s){try{let o=e.uri.fsPath.replace(".eventflux.studio","").replace(".efstudio",""),c=[];if(t){let d=i.Uri.file(`${o}.eventflux`);await i.workspace.fs.writeFile(d,Buffer.from(t)),c.push(f.basename(d.fsPath))}if(s&&s.length>0){let d=this.generateTOML(s);if(d){let a=i.Uri.file(`${o}.toml`);await i.workspace.fs.writeFile(a,Buffer.from(d)),c.push(f.basename(a.fsPath))}}c.length>0?i.window.showInformationMessage(`Exported: ${c.join(", ")}`):i.window.showWarningMessage("Nothing to export")}catch(o){let c=o instanceof Error?o.message:"Unknown error";i.window.showErrorMessage(`Export failed: ${c}`)}}generateTOML(e){let t=["# EventFlux Configuration","# Generated by EventFlux Studio",""],s=e.filter(a=>a.type==="source"),o=e.filter(a=>a.type==="sink"),c=e.filter(a=>a.type==="table");if(![...s,...o,...c].some(a=>a.data?.config&&Object.keys(a.data.config).length>0))return null;t.push("[application]"),t.push('buffer_size = "1024"'),t.push("");for(let a of s){let r=a.data;if(!r?.sourceName||!r?.config||Object.keys(r.config).length===0)continue;t.push(`[streams.${r.sourceName}]`);let l=r.sourceType||"websocket";for(let[u,g]of Object.entries(r.config)){let h=this.convertConfigKey(u,l);t.push(`${h} = "${this.escapeTomlValue(String(g))}"`)}t.push("")}for(let a of o){let r=a.data;if(!r?.sinkName||!r?.config||Object.keys(r.config).length===0)continue;t.push(`[streams.${r.sinkName}]`);let l=r.sinkType||"log";for(let[u,g]of Object.entries(r.config)){let h=this.convertConfigKey(u,l);t.push(`${h} = "${this.escapeTomlValue(String(g))}"`)}t.push("")}for(let a of c){let r=a.data;if(!(!r?.tableName||!r?.config||Object.keys(r.config).length===0)){t.push(`[tables.${r.tableName}]`);for(let[l,u]of Object.entries(r.config))t.push(`${l} = "${this.escapeTomlValue(String(u))}"`);t.push("")}}return t.join(`
`)}escapeTomlValue(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t")}convertConfigKey(e,t){let o={kafka:{"bootstrap.servers":"kafka.brokers",topic:"kafka.topic","group.id":"kafka.group_id","auto.offset.reset":"kafka.auto_offset_reset"},http:{url:"http.url",method:"http.method",headers:"http.headers"},mqtt:{broker:"mqtt.broker",topic:"mqtt.topic",qos:"mqtt.qos"},redis:{host:"redis.host",port:"redis.port",key_prefix:"redis.key_prefix"}}[t];return o&&o[e]?o[e]:e.includes(".")?e:`${t}.${e}`}async getTemplates(){let e=i.Uri.joinPath(this.context.extensionUri,"templates");try{let t=await i.workspace.fs.readDirectory(e),s=[];for(let[o,c]of t)if(c===i.FileType.File&&o.endsWith(".json")){let d=i.Uri.joinPath(e,o),a=await i.workspace.fs.readFile(d),r=JSON.parse(a.toString());s.push({id:o.replace(".json",""),name:r.name||o,description:r.description||""})}return s}catch{return[]}}async loadTemplate(e){let t=i.Uri.joinPath(this.context.extensionUri,"templates",`${e}.json`),s=await i.workspace.fs.readFile(t);return JSON.parse(s.toString())}async runSimulation(e,t){return{success:!0,message:"Simulation not yet implemented",steps:[]}}};function U(){let n="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<32;t++)n+=e.charAt(Math.floor(Math.random()*e.length));return n}function C(n){console.log("EventFlux Studio extension is now active"),n.subscriptions.push(m.register(n)),n.subscriptions.push(p.commands.registerCommand("eventflux.openStudio",async()=>{let e=p.window.activeTextEditor;if(e&&e.document.fileName.endsWith(".eventflux")){let t=e.document.getText();await E(t,e.document.uri)}else p.window.showInformationMessage("Please open an EventFlux (.eventflux) file first")})),n.subscriptions.push(p.commands.registerCommand("eventflux.newStudioProject",async()=>{let e=await p.window.showSaveDialog({filters:{"EventFlux Studio":["eventflux.studio","efstudio"]},saveLabel:"Create Studio Project"});if(e){let t=x();await p.workspace.fs.writeFile(e,Buffer.from(JSON.stringify(t,null,2))),await p.commands.executeCommand("vscode.openWith",e,"eventflux.studioEditor")}}))}function $(){console.log("EventFlux Studio extension is now deactivated")}async function E(n,e){let t=e.path.replace(".eventflux",""),s=p.Uri.file(`${t}.eventflux.studio`),o=x();o.importedSQL=n,o.metadata.importedFrom=e.fsPath,await p.workspace.fs.writeFile(s,Buffer.from(JSON.stringify(o,null,2))),await p.commands.executeCommand("vscode.openWith",s,"eventflux.studioEditor")}function x(){let n=new Date().toISOString();return{$schema:"https://eventflux.io/schemas/studio/v1.json",version:"1.0",name:"Untitled Project",application:{elements:[],connections:[]},layout:{zoom:1,pan:{x:0,y:0},gridSize:20,snapToGrid:!0},metadata:{created:n,modified:n}}}0&&(module.exports={activate,deactivate});
