"use strict";var g=Object.create;var p=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var b=Object.getPrototypeOf,S=Object.prototype.hasOwnProperty;var y=(s,e)=>{for(var t in e)p(s,t,{get:e[t],enumerable:!0})},w=(s,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of x(e))!S.call(s,n)&&n!==t&&p(s,n,{get:()=>e[n],enumerable:!(o=h(e,n))||o.enumerable});return s};var v=(s,e,t)=>(t=s!=null?g(b(s)):{},w(e||!s||!s.__esModule?p(t,"default",{value:s,enumerable:!0}):t,s)),k=s=>w(p({},"__esModule",{value:!0}),s);var U={};y(U,{activate:()=>T,deactivate:()=>D});module.exports=k(U);var a=v(require("vscode"));var i=v(require("vscode")),m=v(require("path")),l=class s{constructor(e){this.context=e}static viewType="eventflux.studioEditor";static webviewOptions={enableScripts:!0,retainContextWhenHidden:!0};static register(e){let t=new s(e);return i.window.registerCustomEditorProvider(s.viewType,t,{webviewOptions:{retainContextWhenHidden:!0},supportsMultipleEditorsPerDocument:!1})}async resolveCustomTextEditor(e,t,o){t.webview.options={enableScripts:!0,localResourceRoots:[i.Uri.joinPath(this.context.extensionUri,"webview","dist"),i.Uri.joinPath(this.context.extensionUri,"templates")]},t.webview.html=this.getHtmlForWebview(t.webview);let n=t.webview.onDidReceiveMessage(c=>this.handleMessage(e,t,c)),d=i.workspace.onDidChangeTextDocument(c=>{c.document.uri.toString()===e.uri.toString()&&this.updateWebview(t.webview,e)});t.onDidDispose(()=>{n.dispose(),d.dispose()}),this.updateWebview(t.webview,e)}getHtmlForWebview(e){let t=e.asWebviewUri(i.Uri.joinPath(this.context.extensionUri,"webview","dist","index.js")),o=e.asWebviewUri(i.Uri.joinPath(this.context.extensionUri,"webview","dist","index.css")),n=P();return`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${e.cspSource} 'unsafe-inline' https://cdn.jsdelivr.net; script-src 'nonce-${n}' 'unsafe-eval' https://cdn.jsdelivr.net; img-src ${e.cspSource} https: data:; font-src ${e.cspSource} https://cdn.jsdelivr.net; connect-src ${e.cspSource} https://cdn.jsdelivr.net; worker-src blob:;">
  <link href="${o}" rel="stylesheet">
  <title>EventFlux Studio</title>
</head>
<body>
  <div id="root"></div>
  <script nonce="${n}" src="${t}"></script>
</body>
</html>`}updateWebview(e,t){try{let o=t.getText(),n=o?JSON.parse(o):null;e.postMessage({type:"load",data:n,fileName:m.basename(t.fileName)})}catch(o){console.error("Failed to parse studio file:",o),e.postMessage({type:"error",message:"Failed to parse studio file. Please check the JSON format."})}}async handleMessage(e,t,o){switch(o.type){case"ready":this.updateWebview(t.webview,e);break;case"update":await this.updateDocument(e,o.content);break;case"generateSQL":let n=await this.generateSQL(o.application);t.webview.postMessage({type:"sqlGenerated",sql:n});break;case"showSQL":await this.showGeneratedSQL(o.sql);break;case"saveSQL":await this.saveSQL(e,o.sql);break;case"getTemplates":let d=await this.getTemplates();t.webview.postMessage({type:"templates",templates:d});break;case"loadTemplate":let c=await this.loadTemplate(o.templateId);t.webview.postMessage({type:"templateLoaded",template:c});break;case"runSimulation":let u=await this.runSimulation(o.application,o.testData);t.webview.postMessage({type:"simulationResult",result:u});break;case"getConfig":let r=i.workspace.getConfiguration("eventflux");t.webview.postMessage({type:"config",config:{gridSize:r.get("studio.gridSize",20),snapToGrid:r.get("studio.snapToGrid",!0),autoSave:r.get("studio.autoSave",!0),engineHost:r.get("engine.host","localhost"),enginePort:r.get("engine.port",9090)}});break}}async updateDocument(e,t){let o=new i.WorkspaceEdit;o.replace(e.uri,new i.Range(0,0,e.lineCount,0),JSON.stringify(t,null,2)),await i.workspace.applyEdit(o)}async generateSQL(e){return`-- Generated by EventFlux Studio
-- Implementation coming soon`}async showGeneratedSQL(e){let t=await i.workspace.openTextDocument({content:e,language:"sql"});await i.window.showTextDocument(t,i.ViewColumn.Beside)}async saveSQL(e,t){let o=e.uri.fsPath.replace(".eventflux.studio","").replace(".efstudio",""),n=i.Uri.file(`${o}.eventflux`);await i.workspace.fs.writeFile(n,Buffer.from(t)),i.window.showInformationMessage(`SQL saved to ${m.basename(n.fsPath)}`)}async getTemplates(){let e=i.Uri.joinPath(this.context.extensionUri,"templates");try{let t=await i.workspace.fs.readDirectory(e),o=[];for(let[n,d]of t)if(d===i.FileType.File&&n.endsWith(".json")){let c=i.Uri.joinPath(e,n),u=await i.workspace.fs.readFile(c),r=JSON.parse(u.toString());o.push({id:n.replace(".json",""),name:r.name||n,description:r.description||""})}return o}catch{return[]}}async loadTemplate(e){let t=i.Uri.joinPath(this.context.extensionUri,"templates",`${e}.json`),o=await i.workspace.fs.readFile(t);return JSON.parse(o.toString())}async runSimulation(e,t){return{success:!0,message:"Simulation not yet implemented",steps:[]}}};function P(){let s="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<32;t++)s+=e.charAt(Math.floor(Math.random()*e.length));return s}function T(s){console.log("EventFlux Studio extension is now active"),s.subscriptions.push(l.register(s)),s.subscriptions.push(a.commands.registerCommand("eventflux.openStudio",async()=>{let e=a.window.activeTextEditor;if(e&&e.document.fileName.endsWith(".eventflux")){let t=e.document.getText();await j(t,e.document.uri)}else a.window.showInformationMessage("Please open an EventFlux (.eventflux) file first")})),s.subscriptions.push(a.commands.registerCommand("eventflux.newStudioProject",async()=>{let e=await a.window.showSaveDialog({filters:{"EventFlux Studio":["eventflux.studio","efstudio"]},saveLabel:"Create Studio Project"});if(e){let t=f();await a.workspace.fs.writeFile(e,Buffer.from(JSON.stringify(t,null,2))),await a.commands.executeCommand("vscode.openWith",e,"eventflux.studioEditor")}}))}function D(){console.log("EventFlux Studio extension is now deactivated")}async function j(s,e){let t=e.path.replace(".eventflux",""),o=a.Uri.file(`${t}.eventflux.studio`),n=f();n.importedSQL=s,n.metadata.importedFrom=e.fsPath,await a.workspace.fs.writeFile(o,Buffer.from(JSON.stringify(n,null,2))),await a.commands.executeCommand("vscode.openWith",o,"eventflux.studioEditor")}function f(){let s=new Date().toISOString();return{$schema:"https://eventflux.io/schemas/studio/v1.json",version:"1.0",name:"Untitled Project",application:{elements:[],connections:[]},layout:{zoom:1,pan:{x:0,y:0},gridSize:20,snapToGrid:!0},metadata:{created:s,modified:s}}}0&&(module.exports={activate,deactivate});
